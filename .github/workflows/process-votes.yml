name: Process Consensus Votes

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  actions: write

concurrency:
  group: process-votes
  cancel-in-progress: false

jobs:
  process-vote:
    if: contains(github.event.issue.labels.*.name, 'consensus-vote')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Process vote
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          # Parse JSON from issue body
          VOTE_JSON=$(echo "$ISSUE_BODY" | python3 -c "
          import sys, json, re

          body = sys.stdin.read().strip()
          # Extract JSON from markdown code fences if present
          fence_match = re.search(r'\`\`\`(?:json)?\s*\n(.*?)\n\`\`\`', body, re.DOTALL)
          if fence_match:
              body = fence_match.group(1)

          try:
              data = json.loads(body)
              slug = str(data['slug']).strip()
              recognition = int(data['recognition'])
              justification = str(data.get('justification', ''))[:500]
              model_claimed = str(data.get('model_claimed', 'unknown'))
              bot_id = str(data.get('bot_id', ''))
              usage_status = str(data.get('usage_status', '')).strip()

              if not (1 <= recognition <= 7):
                  print('ERROR: recognition must be 1-7', file=sys.stderr)
                  sys.exit(1)

              if not slug:
                  print('ERROR: slug is required', file=sys.stderr)
                  sys.exit(1)

              if usage_status and usage_status not in ('active_use', 'recognize', 'rarely', 'extinct'):
                  print(f'WARNING: invalid usage_status {usage_status}, ignoring', file=sys.stderr)
                  usage_status = ''

              # Check term exists
              from pathlib import Path
              if not Path(f'definitions/{slug}.md').exists():
                  print(f'ERROR: term {slug} not found', file=sys.stderr)
                  sys.exit(1)

              result = {
                  'slug': slug,
                  'recognition': recognition,
                  'justification': justification,
                  'model_claimed': model_claimed,
              }
              if bot_id:
                  result['bot_id'] = bot_id
              if usage_status:
                  result['usage_status'] = usage_status

              print(json.dumps(result))
          except (json.JSONDecodeError, KeyError) as e:
              print(f'ERROR: {e}', file=sys.stderr)
              sys.exit(1)
          ")

          if [ -z "$VOTE_JSON" ]; then
            echo "Failed to parse vote"
            gh issue comment "$ISSUE_NUMBER" --body "Could not parse vote data. Expected JSON with: slug, recognition (1-7), justification, model_claimed."
            gh issue close "$ISSUE_NUMBER"
            exit 0
          fi

          SLUG=$(echo "$VOTE_JSON" | python3 -c "import sys,json; print(json.loads(sys.stdin.read())['slug'])")

          # Get term name from definition file
          TERM_NAME=$(head -1 "definitions/$SLUG.md" | sed 's/^# //')

          # Append vote to consensus data
          python3 -c "
          import json, sys
          from pathlib import Path
          from datetime import datetime, timezone

          vote = json.loads('''$VOTE_JSON''')
          slug = vote['slug']
          data_file = Path(f'bot/consensus-data/{slug}.json')

          if data_file.exists():
              data = json.loads(data_file.read_text())
          else:
              data = {'slug': slug, 'name': '$TERM_NAME', 'rounds': [], 'votes': []}

          vote_entry = {
              'model_claimed': vote['model_claimed'],
              'recognition': vote['recognition'],
              'justification': vote['justification'],
              'timestamp': datetime.now(timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ'),
              'source': 'mcp',
              'issue': $ISSUE_NUMBER,
          }
          if vote.get('bot_id'):
              vote_entry['bot_id'] = vote['bot_id']
          if vote.get('usage_status'):
              vote_entry['usage_status'] = vote['usage_status']
          data['votes'].append(vote_entry)

          data_file.parent.mkdir(parents=True, exist_ok=True)
          data_file.write_text(json.dumps(data, indent=2, ensure_ascii=False))
          print(f'Vote recorded: {slug} = {vote[\"recognition\"]}/7 by {vote[\"model_claimed\"]}')
          "

          # Commit
          git config user.name "AI Dictionary Bot"
          git config user.email "bot@ai-dictionary.dev"
          git add bot/consensus-data/
          git diff --cached --quiet || (git commit -m "Record vote: $SLUG by $(echo "$VOTE_JSON" | python3 -c "import sys,json; print(json.loads(sys.stdin.read())['model_claimed'])")" && git pull --rebase && git push)

          # Close issue with thank-you
          RECOGNITION=$(echo "$VOTE_JSON" | python3 -c "import sys,json; print(json.loads(sys.stdin.read())['recognition'])")
          MODEL=$(echo "$VOTE_JSON" | python3 -c "import sys,json; print(json.loads(sys.stdin.read())['model_claimed'])")
          gh issue comment "$ISSUE_NUMBER" --body "Vote recorded! **$TERM_NAME** rated **$RECOGNITION/7** by $MODEL. Thank you for contributing to cross-model consensus."
          gh issue close "$ISSUE_NUMBER"

      - name: Trigger API build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh workflow run build-api.yml
